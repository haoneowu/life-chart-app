# Speckit: Tasks

## Setup
- [x] Initialize Git Monorepo: `apps/web` (Next.js) and `apps/api` (Node.js).
- [x] Install dependencies: `astronomy-engine`, `lightweight-charts`, `framer-motion`, `lucide-react`, `clsx`, `tailwind-merge`.
- [x] Configure `apps/api`: Setup Express or Fastify server.
- [x] Configure Supabase: Create project and get credentials.

## Backend (Calculation Engine)
- [x] Create `apps/api/src/engine/astronomy.ts`: Wrapper for `astronomy-engine`.
- [x] Implement `calculateNatalChart(date, lat, lon)`: Returns planetary positions.
- [x] Implement `calculateTransits(date)`: Returns daily planetary positions.
- [x] Implement `calculateMomentum(natal, transits)`: Logic to compute 0-100 Score and Volatility.
- [x] **Test**: Write unit tests for `calculateMomentum` to ensure deterministic output.

## Database
- [ ] SQL: Create `public.users` table with `latitude`, `longitude`, `timezone`.
- [ ] SQL: Create `public.daily_signals` table (Composite key: user_id + date).
- [ ] SQL: Create `public.interpretations` table.

## Frontend (Chart & UI)
- [x] Component `LifeChart`: Initialize `lightweight-charts` instance.
- [x] Helper `transformToCandles(signals)`: Convert Momentum Score -> OHLC data (Open/High/Low/Close simulation).
- [x] **Chart Interactions**: Handle clicks on candles -> Show Detail Panel (Slide-over/Modal).
- [x] Component `TimeframeSelector`: Toggle Day/Month/Year.
- [x] **Revamp**: `OnboardingForm`:
    - [x] Add `Name` and `Gender` inputs.
    - [x] Replace Lat/Lon input with "City Search" (Autocomplete).
    - [x] Split into styled steps or a clean single-page view.
    - [x] Add entry animations.

## Onboarding Refinements (User Feedback)
- [x] **Main Button**: Update gradient to Teal/Red/Orange (Aurora style) per reference.
- [x] **Subtitle**: Remove background box (clean text).
- [x] **Background**: Speed up particles (1.2-1.5x) and change bg to subtle deep gradient (not pure black).
- [x] **Layout**: Stack inputs in a single column (`grid-cols-1`).
- [x] **Refinement Round 2**:
    - [x] **Fix**: `CityPicker` dropdown z-index issue (Force `z-50` on picker container, `z-0` on button).
    - [x] **Button**: Animate gradient (background-size: 200%, animation: pan).
    - [x] **Layout**: Change Input Box style to **Inline/Horizontal** (Label Left | Input Right).
    - [x] **Starfield**: Increase particle opacity (0.3 -> 0.8) and line opacity (0.3).

## Refinement Round 4 (User Feedback & bugs)
- [x] **Global / Bug Fixes**:
    - [x] **Hydration Error**: Fix `className` mismatch in `CityPicker` input.
    - [x] **Runtime Crash**: Fix `toFixed` error in `DetailPanel` (undefined check).
- [x] **Onboarding**:
    - [x] **Styles**: Fix alignment of Gender/Date dropdowns. Change Date icon color to white.
    - [x] **CityPicker Logic**: Search should only prompt on input (no default list). Search logic should be fuzzy/better (pinyin support if possible, or just strict matches on input). Hide coordinates.
- [x] **Navigation (Sidebar)**:
    - [x] **Assets**: Use `logo.png` (from provided image) for Logo/Favicon.
    - [x] **Structure**: Remove top-level Settings/Account. Fold into User Profile popover at bottom.
    - [x] **User Menu**: Add "Language" option in the new User Profile menu.
    - [x] **Styles**: Center the selected icon. Use `#444444` for active state background (dimmer than white).
    - [x] **Collapsed**: Ensure Logo Icon is visible when collapsed.
- [x] **Chart Detail Page**:
    - [x] **Default State**: Open "Day Detail" (selected day) by default upon entry (select "Today" if new).
    - [x] **Visuals**: Replace Zodiac icons with style matching reference (use simple bold SVGs or sprite if possible).
    - [x] **Cleanup**: Hide TradingView logo (via CSS or config).
    - [x] **Controls**: Segmented control Day/Month/Year (default Day).

## Refinement Round 5 (Final MVP)
- [x] **Onboarding (Input Page)**:
    - [x] **Layout**: Refactor to LG Horizontal Split (Label Left | Input Right) on desktop.
    - [x] **Inputs**: Add "Birth Hour" and "Birth Minute" (HH:MM) precision.
    - [x] **Assets**: Replace logo with `logo.svg`.
- [x] **Navigation (Sidebar)**:
    - [x] **Logo**: Update Sidebar logo and favicon with `logo.svg`.
- [x] **Chart Detail Page (Header)**:
    - [x] **Collapse**: Default planetary details to collapsed.
    - [x] **Identity**: Replace planetary summary with User Birth Info (Time, Place).
    - [x] **Cleanup**: Remove "Momentum: Active" text.
    - [x] **Icons**: Replace all Zodiac icons with provided individual PNG assets.
- [x] **Advanced Charting (K-Line)**:
    - [x] **Clean Up**: Implementation of CSS hack to hide TradingView logo.
    - [x] **Interactivity**: Enable historical dragging and ensure smooth scaling.
    - [x] **Selection**: Ensure a candle is selected on landing; persistent selection state.
    - [x] **Timeframes**: Remove 'Week', implement 'Day', 'Month', 'Year'.
    - [x] **Pillars**: Wire up the 5 Life Pillars (Overall, Career, Money, Relationships, Energy). 
    - [x] **State Machine**: Implement selection logic and panel persistence when switching timeframes.
- [x] **Detail Panel (Right Side)**:
    - [x] **Typography**: Change body text to Sans-Serif (Inter), increase size to 1.125rem+.
    - [x] **Navigation**: Add Forward/Backward arrows for sequence browsing.
    - [x] **Structure**: Restructured into Why, What, When, How categories.
- [x] **Backend & Logic**:
    - [x] **Key Date**: Define deterministic logic for Next Key Date flagging.
    - [x] **Pillars**: Update API to provide variation data (weighted planetary scores) for the 5 Pillars.
    - [x] **Time Windows**: Implement semantic time windows (Morning/Afternoon/Evening) for interpretation.

## Refinement Round 3 (Visuals & Data)
- [x] **Onboarding**:
    - [x] **Button**: Remove outer glow/shadow to fix "strange light".
    - [x] **CityPicker**: Default empty state (show no prompt), fix text prompt visibility when typing, add Country/State to search result.
- [x] **Navigation (Sidebar)**:
    - [x] Remove left black bar indicator for selected item.
    - [x] **Layout**: Move Settings/User Profile to bottom (ChatGPT style) with Avatar expanded layout.
- [x] **Chart Detail Page**:
    - [x] **Auto-Expand**: Ensure K-Line chart opens with panel expanded by default.
    - [x] **Identity**: Fix Name display (currently showing City). Add "User Brief" (3-4 lines of attributes).
    - [x] **Planets**: Show ALL planets (Sun to Pluto, excluding asteroids if needed, but fill the list).
    - [x] **Zodiac Icons**: Crop and use provided Zodiac SVG image for circular avatars.
- [x] **Chart Area**:
    - [x] **Clean Up**: Remove TradingView logo (if customizable/authorized) or hide.
    - [x] **New Chart**: Move "New Chart" button to Sidebar (under logo).
    - [x] **Timeframe**: Implement Day/Week/Month granularity switch.

## Visuals & Immersion (Particles & Glass)
- [x] **Background**: Create `ParticlesBackground` component (Canvas/react-particles).
- [x] **Onboarding UI**:
    - [x] Implement Glassmorphism panel (backdrop-blur, border gradients).
    - [x] **Hero Button**: Add energy gradient animation (css keyframes).
- [x] **Assets**: Add 12 Zodiac SVG icons to `components/icons/zodiac`.

## Advanced Charting (K-Line Page)
- [x] **Backend**: Update `POST /chart` to return `{ chartData, natalDetails: { sun, moon, ... } }`.
- [x] **Header**: Create `ChartHeader` component.
    - [x] Display Name, Sun Sign, and Avatar.
    - [x] Collapsible "Planetary Details" table.
- [x] **Chart Controls**:
    - [x] "Back to Today" floating button.
    - [x] Timeframe Segmented Control (Day/Month/Year).
- [x] **Detail Panel**:
    - [x] Layout update: Header (Date/Score), Body (Advice), Footer (Share).
    - [x] "Share Card" visual update.

## Design & Experience Overhaul (Gemini.md)
- [x] **Typography**: Install `Cormorant Garamond` (Display), `Space Mono` (Data), and `Inter` (Body). Apply "High Contrast" principle.
- [x] **Layout**: Add "Fake" Left Sidebar (Branding, History, Settings) for demo purposes.
- [ ] **Interactions**:
    - [ ] Staggered Text Reveal on load.
    - [ ] Magnetic Buttons or Custom Cursor effect.
    - [ ] Smooth Chart Entry animation.
- [ ] **Imagery**: Add high-quality background/accent images from Unsplash.

## API Integration
- [ ] **API Endpoint** `POST /chart`: Accepts `{ birth_data, range }`. Returns `[candles]`.
- [ ] **API Endpoint** `GET /interpretation`: Accepts `{ signal_data }`. Checks cache -> Calls LLM -> Returns text.

## Virality
- [ ] Component `ShareCard`: Visual representation of "Today's Candle".
- [ ] Function `generateShareImage()`: Export component as PNG.

## Deploy
- [ ] Configure `railway.json` for `apps/api`.
- [ ] Configure `vercel.json` for `apps/web`.